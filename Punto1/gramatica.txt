Programa → SentenciaLista
{
    tsActual  = new TablaSimbolos(null);   // ámbito global (tablas)
    sp = 0; maxstack = 0;
    Programa.trad = SentenciaLista.trad;
}

// Sentencias CRUD

SentenciaLista → Sentencia SentenciaLista
{
    SentenciaLista.trad = Sentencia.trad || SentenciaLista.trad;
}
SentenciaLista → ε
{
    SentenciaLista.trad = "";
}

Sentencia → CreateTable ';'
{
    tipoFuncion = void; // no devuelve filas
    Sentencia.trad = CreateTable.trad || ";\n";
}
Sentencia → Insert ';'
{
    tipoFuncion = int; // filas insertadas
    Sentencia.trad = Insert.trad || ";\n";
}
Sentencia → Select ';'
{
    tipoFuncion = resultset; // conjunto de resultados
    Sentencia.trad = Select.trad || ";\n";
}
Sentencia → Update ';'
{
    tipoFuncion = int; // filas modificadas
    Sentencia.trad = Update.trad || ";\n";
}
Sentencia → Delete ';'
{
    tipoFuncion = int; // filas borradas
    Sentencia.trad = Delete.trad || ";\n";
}

// Create

CreateTable → 'CREATE' 'TABLE' id '('
{
    tsActual.nuevoSimbolo(id.lexema, tipoTabla);
    tsActual = new TablaSimbolos(tsActual);
}
DefCampoLista OptPK ')'
{
    // guardar info de columnas y pk
    guardarTabla(id.lexema, DefCampoLista.cols, DefCampoLista.tipos, OptPK.pk);
    tsActual = tsActual.pop();    // cerrar ámbito columnas

    CreateTable.trad =
        "CREATE TABLE " || id.lexema || "(" ||
        DefCampoLista.trad || OptPK.trad || ")";
}

DefCampoLista → DefCampo RestCampos
{
   DefCampoLista.cols  = [DefCampo.col]  ++ RestCampos.cols;
   DefCampoLista.tipos = [DefCampo.tipo] ++ RestCampos.tipos;
   DefCampoLista.trad  = DefCampo.trad || RestCampos.trad;
}

RestCampos → ',' DefCampo RestCampos1
{
   RestCampos.cols  = [DefCampo.col]  ++ RestCampos1.cols;
   RestCampos.tipos = [DefCampo.tipo] ++ RestCampos1.tipos;
   RestCampos.trad  = "," || DefCampo.trad || RestCampos1.trad;
}
RestCampos → ε
{
   RestCampos.cols  = [];
   RestCampos.tipos = [];
   RestCampos.trad  = "";
}

DefCampo → id Tipo
{
    tsActual.nuevoSimbolo(id.lexema, Tipo.tipo);
    DefCampo.col  = id.lexema;
    DefCampo.tipo = Tipo.tipo;
    DefCampo.trad = id.lexema || " " || Tipo.trad;
}

Tipo → 'INT'   { Tipo.tipo=int;   Tipo.trad="INT";   }
Tipo → 'FLOAT' { Tipo.tipo=float; Tipo.trad="FLOAT"; }
Tipo → 'TEXT'  { Tipo.tipo=text;  Tipo.trad="TEXT";  }

OptPK → ',' 'PRIMARY' 'KEY' '(' id ')'
{
    OptPK.pk   = id.lexema;
    OptPK.trad = ", PRIMARY KEY(" || id.lexema || ")";
}
OptPK → ε
{
    OptPK.pk   = null;
    OptPK.trad = "";
}

// Read

Select → 'SELECT' '*' 'FROM' id
{
    // lectura de todas las columnas
    if not existeTabla(tsActual, id.lexema)
        error("Tabla no declarada: " || id.lexema);

    Select.trad = "SELECT * FROM " || id.lexema;
}

// Update

Update → 'UPDATE' id 'SET' id2 '=' Valor
{
    if not existeTabla(tsActual, id.lexema)
        error("Tabla no declarada: " || id.lexema);
    if not existeColumna(tsActual, id.lexema, id2.lexema)
        error("Columna no declarada: " || id2.lexema);

    // tipo de la expresión debe coincidir con tipo de la columna
    tipoCol = tipoColumna(tsActual, id.lexema, id2.lexema);
    if Valor.tipo != tipoCol
        error("Tipo incompatible en UPDATE");

    Update.trad =
        "UPDATE " || id.lexema ||
        " SET " || id2.lexema || " = " || Valor.trad;
}

// Delete

Delete → 'DELETE' 'FROM' id
{
    if not existeTabla(tsActual, id.lexema)
        error("Tabla no declarada: " || id.lexema);

    Delete.trad = "DELETE FROM " || id.lexema;
}

// Valores (pila sp)

Valor → num
{
    Valor.val  = num.lexema;
    Valor.tipo = int;
    Valor.trad = num.lexema;

    // simulamos ldc.i4 → sp++
    sp = sp + 1;
    if sp > maxstack then maxstack = sp;
}

Valor → str
{
    Valor.val  = str.lexema;
    Valor.tipo = text;
    Valor.trad = str.lexema;

    sp = sp + 1;
    if sp > maxstack then maxstack = sp;
}

Valor → 'TRUE'
{
    Valor.val  = true;
    Valor.tipo = bool;
    Valor.trad = "TRUE";
    sp = sp + 1;
    if sp > maxstack then maxstack = sp;
}

Valor → 'FALSE'
{
    Valor.val  = false;
    Valor.tipo = bool;
    Valor.trad = "FALSE";
    sp = sp + 1;
    if sp > maxstack then maxstack = sp;
}
